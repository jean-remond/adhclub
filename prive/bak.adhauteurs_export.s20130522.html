#CACHE{0}
<?php
/**
 * Plugin adh_club : Adherent Club pour Spip 2.1
 * Licence GPL (c) 2011-2013 Jean Remond
 *
 * ----------------------------------------------
 * Affichage de Export d'auteurs F(requete SQL pre-define)
 *  pour sauvegarde locale.
 *  cf formulaires/adh_i3_recherche. 
 * ----------------------------------------------
 * @todo-JR-01/05/2013-Finaliser la recuperation en locale (enregistrement).
 * 
 * Fait :
 * ----
 * JR-30/04/2013-Creation du squelette.
 *
 */

// Les variables
$file_type = #ENV{file_type};
$file_view = #ENV{file_view};
$file_path = #ENV{file_path};
$file_name = #ENV{file_name};
		
$debug1= "adhclub debug JR : prive/adhauteurs_export - Pt05 - ";
adhclub_log("$debug1.", true);
$debug1= "file_type=" . $file_type . ", file_view=". $file_view. ", file_path=". $file_path. ", file_name=". $file_name;
adhclub_log("$debug1.", true);


$file_out = $file_path.$file_name;

//Si on est en mutualise avec masquages des vraies urls d'images
if (stripos($GLOBALS['spip_pipeline']['affichage_final'],'mutualisation_url_img_courtes')){
	$file_out = str_replace(_DIR_IMG,_DIR_RACINE . _NOM_PERMANENTS_ACCESSIBLES,$file_out);
}

if($file_type == 'csv'){
		
	$debug1= "adhclub debug JR : prive/adhauteurs_export - Pt15 - ";
	adhclub_log("$debug1.", true);
	$debug1= "file_type=" . $file_type . ", file_view=". $file_view. ", file_path=". $file_path. ", file_name=". $file_name;
	adhclub_log("$debug1.", true);

	// Vous voulez afficher un csv
	header( 'Content-type: text/comma-separated-values' );
	//header("Content-type: application/force-download");
	header("Content-Description: File Transfer");
	header("Content-Length: ".filesize($file_out));
		
	// Il sera nomme $file_name
	// ATTENTION : pour "filename", mettre un nom de fichier court (<nom>.<extension>)
	// sinon IE 6 SP2 ne reconnaitra pas le type de fichier
	// Semble poser probleme sous IE6 SP1
	// Ah,  Microsoft, je vous jure !
	header('Content-Disposition: attachment; filename=' . urlencode($file_name));
		
	// Le source du CSV original.csv
	readfile($file_out);
	unlink($file_out);

	/* Assurez-vous que la suite du code ne soit pas exécutée une fois la redirection effectuée. */
	exit;
}

?>